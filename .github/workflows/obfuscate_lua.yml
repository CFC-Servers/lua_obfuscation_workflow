name: "Lua obfuscator"

on:
  workflow_call:
    inputs:
      dirs:
        type: string
        required: true
        description: "JSON Array of the dirs that should be obfuscated"

      input-branch:
        type: string
        description: "Which branch to clone and obfuscate"
        default: ${{ github.event.repository.default_branch }}
        required: false

      output-branch:
        type: string
        description: "Which branch to force-push the obfuscated code to"
        default: "obfuscated"
        required: false

jobs:
  obfuscate:
    name: "Perform Obfuscation"
    runs-on: ubuntu-18.04

    steps:
      - name: "Check out the repo"
        uses: actions/checkout@v2
        with:
          repository: ${{ github.repository }}
          path: project
          ref: ${{ inputs.input-branch }}

      - name: "APT Update"
        run: sudo apt update -y

      - name: "Set up Lua"
        run: sudo apt install -y lua5.1

      - name: "Check out the obfuscator"
        uses: actions/checkout@v2
        with:
          repository: levno-710/Prometheus
          path: prometheus

      - name: "Status"
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          echo "PWD: $(pwd)"
          echo "LS: $(ls -alh)"
          echo "Input branch: ${{ inputs.input-branch }}"
          echo "Output branch: ${{ inputs.output-branch }}"
          echo "Dirs: ${{ inputs.dirs }}"

      - name: "Enter project"
        run: cd "project"

      - name: "Save the dirs config"
        run: echo "${{ inputs.dirs }}" > "$GITHUB_WORKSPACE/dirs.json" && cat "$GITHUB_WORKSPACE/dirs.json"

      - name: "Status2"
        run: |
          cd "$GITHUB_WORKSPACE/project"
          echo "Workspace: $GITHUB_WORKSPACE"
          echo "PWD: $(pwd)"
          echo "LS: $(ls -alh)"

      - name: "Run obfuscator"
        run: |
          cd "$GITHUB_WORKSPACE/project"
          jq -c '.[]' "$GITHUB_WORKSPACE/dirs.json" | while read i; do find . -name "*.lua" -exec echo "{}" && lua5.1 ../prometheus/cli.lua --preset Strong --out "{}" "{}" \; done

      - name: "Remove .github"
        run: |
          cd "$GITHUB_WORKSPACE/project"
          rm -rfv .github

      - name: "Create VERSION file"
        run: echo -e "${{ github.ref }}" > VERSION

      - name: Push to lua branch
        run: |
          cd "$GITHUB_WORKSPACE/project"
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "Obfuscation run for: $(cat VERSION)"
          git push -f origin "HEAD:${{ inputs.output-branch }}"

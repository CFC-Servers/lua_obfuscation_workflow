name: "Lua obfuscator"

on:
  workflow_call:
    inputs:
      paths:
        type: string
        required: true
        description: "JSON Array of the paths that should be obfuscated"

      input-branch:
        type: string
        description: "Which branch to clone and obfuscate"
        default: ${{ github.event.repository.default_branch }}
        required: false

      output-branch:
        type: string
        description: "Which branch to force-push the obfuscated code to"
        default: "obfuscated"
        required: false

      preset:
        type: string
        description: "Which obfuscation preset to use"
        default: Strong
        required: false

      censor-commits:
        type: string
        description: "Whether or not to censor commit messages"
        default: 'false'
        required: false

jobs:
  obfuscate:
    name: "Perform Obfuscation"
    runs-on: ubuntu-18.04

    steps:
      - name: "Check out the repo"
        uses: actions/checkout@v2
        with:
          repository: ${{ github.repository }}
          path: project
          ref: ${{ inputs.input-branch }}

      - name: "Check out the obfuscator"
        uses: actions/checkout@v2
        with:
          repository: levno-710/Prometheus
          path: prometheus

      - name: "Set up Lua"
        run: sudo apt install -y lua5.1

      - name: "Save the paths config"
        run: echo -e '${{ inputs.paths }}' > "$GITHUB_WORKSPACE/paths.json" && cat "$GITHUB_WORKSPACE/paths.json"

      - name: "Run obfuscator"
        run: |
          cd "$GITHUB_WORKSPACE/project";
          readarray -t paths < <(jq -rc '.[]' "$GITHUB_WORKSPACE/paths.json");

          for path in "${paths[@]}"; do \
              find ./$path -type f -name "*.lua" -exec lua5.1 ../prometheus/cli.lua --preset ${{ inputs.preset }} --out "{}" "{}" \;
          done;

          sleep 1;

      - name: "Git status"
        run: |
          cd "$GITHUB_WORKSPACE/project"
          git status

      - name: "Remove .github"
        run: |
          cd "$GITHUB_WORKSPACE/project"
          rm -rfv .github

      - name: "Create VERSION file"
        run: |
          cd "$GITHUB_WORKSPACE/project"
          echo -e "${{ github.sha }}" > VERSION

      - name: Stage commit
        run: |
          cd "$GITHUB_WORKSPACE/project"
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "Obfuscation run for: $(cat VERSION)"

      - name: Censor commit messages
        if: ${{ inputs.censor-commits == 'true' }}
        run: |
          cd "$GITHUB_WORKSPACE/project"
          export FILTER_BRANCH_SQUELCH_WARNING=1
          git filter-branch -f --msg-filter 'sed "s/[[:alnum:]]/‚ùö/g"'

      - name: Push to branch
        run: |
          cd "$GITHUB_WORKSPACE/project"
          git push -f origin "HEAD:${{ inputs.output-branch }}"
